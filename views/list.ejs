<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¸€ëª©ë¡</title>  
  <link href="/css/main.css" rel="stylesheet">
</head>
<body class = "grey-bg">
  <%- include('nav.ejs') %>
  <!--<%=JSON.stringify(ê¸€ëª©ë¡) %>-->
  <div class="grey-bg" style="float:right;margin-right:20px;margin-top:15px;">
    <%for (let i=1; i <= Math.ceil(ê¸€ìˆ˜/10); i++) { %>
      <button id="button" type="button" onclick="location.href='/list/<%=i%>' " class="btn btn-primary" >
      <%= i %>
      </button>
    <% } %>    
  </div>
  
    <form class="search" action="/searchWord/1" style="margin-left:20px;">
      <input name="keyword" class="form-control" id="keyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" style="margin-top:15px">
      <img class="icon" src="https://lincolncaforum1.s3.us-west-1.amazonaws.com/1716148470030" id="searchButton">    
    </form>
  
  
  <div class="white-bg">
    <%for(let i=0;i < ê¸€ëª©ë¡.length; i++){%>
      <div class="list-box">
        <h4>
          <a href="/detail/<%=ê¸€ëª©ë¡[i]._id%>" style="text-decoration:none; color:#000">
            <%= ê¸€ëª©ë¡[i].title %>            
          </a>
          <%if (signed == 1) {%>
            <span class="edit" data-id = "<%=ê¸€ëª©ë¡[i]._id%>" data-userid="<%= ê¸€ëª©ë¡[i].user %>" style="cursor:pointer">âœ</span> 
            <a id="delete" class="delete" style="cursor:pointer; float:right; text-decoration:none;" data-id="<%= ê¸€ëª©ë¡[i]._id%>" data-user="<%= ê¸€ëª©ë¡[i].username%>">ğŸ—‘</a>               <!-- htmlì— _id ìˆ¨ê²¨ë†“ìŒ-->
          <% } %>
        </h4>
         <!-- ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§-->
         <%if (ê¸€ëª©ë¡[i].content.indexOf('![](') != -1) { %> <!--ì‚¬ì§„ì´ ìˆëŠ” ê¸€ì¼ ê²½ìš° -->
          <p><%= ê¸€ëª©ë¡[i].content.substring(0, ê¸€ëª©ë¡[i].content.indexOf('![](') - 1) %></p>
          <a href="/detail/<%=ê¸€ëª©ë¡[i]._id%>"><img src="<%=ê¸€ëª©ë¡[i].content.substring(ê¸€ëª©ë¡[i].content.indexOf('![](') + 4, ê¸€ëª©ë¡[i].content.indexOf(')'))%>" style="width:200px"/></a><!--ë¯¸ë¦¬ë³´ê¸°ëŠ” ì œì¼ ì•ì˜ í•œì¥ë§Œ ì œê³µ-->
        <% } else { %>
          <p><%= ê¸€ëª©ë¡[i].content %></p>
        <% } %>
      </div>
    <% } %>    
  </div>
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>  

  <script>
    document.getElementById('searchButton').addEventListener('click', function(){
    let keyword = document.getElementById('keyword').value
    location.href = '/searchWord/1?keyword='+keyword
    })
    if(<%=signed%> == 1) {
      for(let i = 0; i < '<%=ê¸€ëª©ë¡.length%>'; i++){        //ejs ë¬¸ë²•ì€ javascriptì•ˆì—ì„œ '' ì•ˆì— string í˜•íƒœë¡œ ë„£ì–´ì¤˜ì•¼ ì¸ì‹
        document.querySelectorAll('.edit')[i].addEventListener('click', function(e) {
          if(e.target.dataset.userid != '<%=user._id%>') {
            return alert('ì‘ì„±ì ë³¸ì¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤')
          } else {
            location.href = '/edit/'+ e.target.dataset.id
          }
        })
        document.querySelectorAll('.delete')[i].addEventListener('click', function(e) { //ì•„ë˜ ê¸°ëŠ¥ì€ ì½œë°±í•¨ìˆ˜ íŒŒë¼ë¯¸í„° eë¥¼ ì¨ì•¼ì§€ ì‚¬ìš© ê°€ëŠ¥í•¨
          if(e.target.dataset.user != '<%=user.username%>') {  //!!!ì¤‘ìš” ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë³€ìˆ˜ ì •ë³´ëŠ” ejsë¬¸ë²•ìœ¼ë¡œ ê°€ì ¸ì˜¬ë•Œ '' ë¥¼ í•´ì¤˜ì•¼ stringíƒ€ì…ìœ¼ë¡œ ë¹„êµê°€ ê°€ëŠ¥í•´ì§
            return alert('ì‘ì„±ì ë³¸ì¸ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤')
          } else {
            fetch('/delete?docId=' + e.target.dataset.id, {  //e.target.dataset.id e.target ì€ í˜„ì¬ ìœ ì €ê°€ í´ë¦­í•œ íƒ€ê²Ÿì„ ê°€ë¦¬í‚´ ê·¸ ì•ˆì˜ dataset.idë¥¼ ê°€ì ¸ì˜¤ë€ë§ /delete? ... Query String ë¬¸ë²•ì´ë¼ ë¶€ë¦„
              method : 'DELETE'
            })
          .then((r)=>r.text())                             //ì„œë²„ì—ì„œ ë³´ë‚¸ ë°ì´í„° 'r', ì„œë²„ì—ì„œ ë³´ë‚´ëŠ” rì„ ì¶œë ¥í•˜ê³ ì‹¶ìœ¼ë©´ ë¬¸ìì¼ ê²½ìš°: r.text() ì˜¤ë¸Œì íŠ¸ê°™ì€ ê²½ìš°: r.json()
          .then((r)=>{                                    //í´ë¦­í•œ elementì˜ ë¶€ëª¨ì˜ ë¶€ëª¨ì˜ (list_box) ë¥¼ ì•ˆë³´ì´ê²Œ ì²˜ë¦¬, ì¦‰ í˜„ì¬ ajaxëŠ” ìƒˆë¡œê³ ì¹¨ì—†ì´ DBì˜ rowë¥¼ ì§€ìš¸ìˆ˜ìˆìœ¼ë‚˜ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì„ ì•ˆí•˜ê¸°ë•Œë¬¸ì— ë°”ë¡œëŠ” ì§€ì›Œì§„ê²Œ ì•ˆë³´ì„
            e.target.parentElement.parentElement.style.display='none'; //ê·¸ë˜ì„œ ajaxë¡œ list_box elementë¥¼ ì§€ìš°ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€
          })
          //html ë³´ì—¬ì£¼ëŠ”ë²• 1. ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§: ì„œë²„ê°€ htmlíŒŒì¼ì„ ë³´ë‚´ì¤˜ì„œ ì›¹í˜ì´ì§€ í‘œì‹œ(í•­ìƒ ìƒˆë¡œê³ ì¹¨), 2.í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ ë Œë”ë§: ì„œë²„ê°€ ë°ì´í„°ë§Œ ë³´ë‚´ê³  ajaxë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì™„ì„±í•˜ê¸°(ìƒˆë¡œê³ ì¹¨ ì—†ì–´ë„ ê°€ëŠ¥)
          //í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ ë Œë”ë§ ì‚¬ìš© (reactë¡œ í•˜ë©´ í¸í•˜ë‹¤ê³ í•¨)
          }
        })
      }
    // document.getElementById("button").style.display="none"
    }
    
  </script>
  <script>
    //SSE ì—°ê²°
    let eventSource= new EventSource('/stream/list')  //ìœ ì €ê°€ listí˜ì´ì§€ë¡œ ë“¤ì–´ê°€ë©´ í•˜ë‹¨ì˜ SSEì½”ë“œê°€ ì‘ë™ëœë‹¤
    eventSource.addEventListener('msg', function(e) { //ì„œë²„ê°€ msgë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ë©´ ë‚´ë¶€ì˜ ì½”ë“œê°€ ì‘ë™
      //json.stringifyë¡œ ê°€ì ¸ì˜¨ jsonì€ objectê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ë°”ë¡œ e.data.title ê°™ì´ ë©¤ë²„ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥ objectë¡œ ë°”ê¿”ì£¼ê¸°ìœ„í•´ JSON.parse(e.data)ë¥¼ ì‚¬ìš©
      let sentData = JSON.parse(e.data)
      console.log(sentData)
      console.log(sentData.username)
      
      document.getElementById('toast-container').insertAdjacentHTML('afterbegin', `<div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><string class="me-auto">${sentData.posterUsername}</string><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body">${sentData.text}</div></div>`)
      const toastNotification = document.getElementById('notification')
      const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastNotification)
      toastBootstrap.show()
      toastNotification.addEventListener('click', () => {
        location.href = `/chat/detail/${sentData.parentId}`
      })
    })
  </script>
</body>
</html>